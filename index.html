<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reading Hub</title>
  <style>
    html { background: #0b0c10; }
    body { display: none; }
  </style>
  <script>
  (async () => {
    const API = "https://reading-redirect-hub.danielzhang139.workers.dev";
    const params = new URLSearchParams(location.hash.slice(1));
    if (params.get("ui") === "1") return;
    try {
      const res = await fetch(API + "/current");
      const data = await res.json();
      const target = data?.current?.url;
      if (target) location.replace(target);
    } catch {}
  })();
  </script>
  <style>
    :root { --bg:#0b0c10; --fg:#e7e7e7; --muted:#b7b7b7; --card:#14161d; --border:#2a2f3a; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--fg); }
    header { padding:16px 18px; border-bottom:1px solid var(--border); position:sticky; top:0; background:rgba(11,12,16,0.92); backdrop-filter: blur(6px); }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input, button, textarea, select {
      background:var(--card); color:var(--fg); border:1px solid var(--border);
      border-radius:10px; padding:10px 12px; font-size:14px;
    }
    input { min-width: 260px; flex: 1; }
    button { cursor:pointer; }
    button.primary { border-color:#3b82f6; }
    button.danger { border-color:#ef4444; }
    main { padding:18px; max-width: 1100px; margin: 0 auto; }
    .hint { color:var(--muted); font-size:13px; margin-top:8px; line-height:1.4; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; margin: 12px 0; }
    .item { display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
    .meta { color:var(--muted); font-size:12px; margin-top:4px; }
    a { color:#93c5fd; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .badge { font-size:12px; color:var(--muted); border:1px solid var(--border); border-radius:999px; padding:2px 8px; }
    .small { font-size:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <strong>Reading Hub</strong>
    <span class="badge" id="status"></span>
    <span style="flex:1"></span>
    <button id="openUi">Open UI</button>
    <button id="goNow" class="primary">Go to saved target</button>
  </div>
  <div class="row" style="margin-top:10px;">
    <input id="q" placeholder="Search history (title / url / note)..." />
    <select id="sort">
      <option value="new">Newest first</option>
      <option value="old">Oldest first</option>
      <option value="az">Title A&rarr;Z</option>
    </select>
  </div>
  <div class="hint">
    Default behavior: if you visit this page normally, it auto-redirects to your saved target.<br/>
    Add <span class="mono">#ui=1</span> to open the UI.
  </div>
</header>

<main>
  <div class="card">
    <div class="row">
      <input id="currentUrl" placeholder="Current target URL..." />
      <input id="currentTitle" placeholder="Optional title..." />
      <input id="currentNote" placeholder="Optional note..." />
      <button id="save" class="primary">Save as current</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <strong>History</strong>
      <span class="small" id="count"></span>
    </div>
    <div id="list"></div>
  </div>
</main>

<script>
(() => {
  const API = "https://reading-redirect-hub.danielzhang139.workers.dev";

  let state = { current: null, history: [] };

  function formatTime(iso) {
    try { return new Date(iso).toLocaleString(); } catch { return iso; }
  }
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function encodeAttr(s) {
    return String(s).replace(/"/g, "&quot;");
  }

  function render() {
    const current = state.current;

    document.getElementById("status").textContent =
      current ? `Current: ${current.title || new URL(current.url).hostname}` : "No current target set";

    document.getElementById("currentUrl").value = current?.url || "";
    document.getElementById("currentTitle").value = current?.title || "";
    document.getElementById("currentNote").value = current?.note || "";

    const q = (document.getElementById("q").value || "").toLowerCase().trim();
    const sort = document.getElementById("sort").value;

    let items = [...state.history];

    if (q) {
      items = items.filter(x =>
        (x.title || "").toLowerCase().includes(q) ||
        (x.url || "").toLowerCase().includes(q) ||
        (x.note || "").toLowerCase().includes(q)
      );
    }

    if (sort === "old") items.reverse();
    if (sort === "az") items.sort((a,b) => (a.title || "").localeCompare(b.title || ""));

    document.getElementById("count").textContent = `${items.length} item(s) shown`;

    const list = document.getElementById("list");
    list.innerHTML = "";

    for (const x of items) {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div class="item">
          <div style="min-width:0;">
            <div><a href="${x.url}" target="_self" rel="noreferrer">${escapeHtml(x.title || x.url)}</a></div>
            <div class="meta">
              <span>${escapeHtml(formatTime(x.ts))}</span>
              ${x.note ? ` &middot; <span>${escapeHtml(x.note)}</span>` : ""}
              <div class="mono" style="word-break:break-all; margin-top:6px; color: var(--muted);">${escapeHtml(x.url)}</div>
            </div>
          </div>
          <div class="row" style="flex-wrap:nowrap;">
            <button data-act="makeCurrent" data-url="${encodeAttr(x.url)}" data-title="${encodeAttr(x.title||"")}" data-note="${encodeAttr(x.note||"")}">Make current</button>
            <button data-act="copy" data-url="${encodeAttr(x.url)}">Copy URL</button>
          </div>
        </div>
      `;
      list.appendChild(div);
    }
  }

  async function loadFromApi() {
    const [curRes, histRes] = await Promise.all([
      fetch(API + "/current"),
      fetch(API + "/history"),
    ]);
    const curData = await curRes.json();
    const histData = await histRes.json();
    state.current = curData.current;
    state.history = histData.history || [];
    render();
  }

  async function saveCurrent(url, title, note) {
    const params = new URLSearchParams({ url, title, note });
    const res = await fetch(API + "/set?" + params);
    const data = await res.json();
    state.current = data.current;
    state.history.unshift(data.current);
    state.history = state.history.filter((x, i) => i === 0 || x.url !== data.current.url);
    render();
  }

  // --- Event wiring ---
  document.getElementById("openUi").addEventListener("click", () => {
    location.hash = "ui=1";
  });

  document.getElementById("goNow").addEventListener("click", () => {
    if (state.current?.url) location.href = state.current.url;
    else alert("No current target set yet.");
  });

  document.getElementById("save").addEventListener("click", () => {
    const url = (document.getElementById("currentUrl").value || "").trim();
    const title = (document.getElementById("currentTitle").value || "").trim();
    const note = (document.getElementById("currentNote").value || "").trim();
    if (!url) return alert("Paste a URL first.");
    saveCurrent(url, title, note);
  });

  document.getElementById("q").addEventListener("input", render);
  document.getElementById("sort").addEventListener("change", render);

  document.body.addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const act = btn.getAttribute("data-act");
    if (!act) return;

    if (act === "makeCurrent") {
      const url = btn.getAttribute("data-url");
      const title = btn.getAttribute("data-title") || "";
      const note = btn.getAttribute("data-note") || "";
      if (url) await saveCurrent(url, title, note);
    } else if (act === "copy") {
      const url = btn.getAttribute("data-url");
      if (!url) return;
      await navigator.clipboard.writeText(url);
      btn.textContent = "Copied!";
      setTimeout(() => btn.textContent = "Copy URL", 700);
    }
  });

  // init
  loadFromApi();
  document.body.style.display = "block";
})();
</script>
</body>
</html>
